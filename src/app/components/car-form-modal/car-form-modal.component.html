<!-- src/app/features/cars/car-form-modal/car-form-modal.component.html -->
<div class="modal-overlay" *ngIf="show">
  <div class="modal" (click)="$event.stopPropagation()">
    
    <!-- Header -->
    <div class="modal-header">
      <h2>{{ isEditMode ? 'Bearbeiten' : 'Neues Auto' }}</h2>
      <button class="modal-close" (click)="onClose()">
        <span class="material-symbols-outlined">close</span>
      </button>
    </div>

    <!-- Body -->
    <div class="modal-body">
      <form [formGroup]="carForm" class="car-form">

        <!-- Basis Info - Always visible -->
        <div class="form-section">
          <div class="form-group">
            <label for="name">Name *</label>
            <input type="text" id="name" class="input" formControlName="name" 
              placeholder="z.B. Mein Golf GTI" [class.input--error]="isFieldInvalid('name')">
            <span class="input-error" *ngIf="isFieldInvalid('name')">{{ getFieldError('name') }}</span>
          </div>

          <div class="form-row-2">
            <div class="form-group">
              <label for="make">Marke *</label>
              <input type="text" id="make" class="input" formControlName="make" 
                placeholder="VW" [class.input--error]="isFieldInvalid('make')">
              <span class="input-error" *ngIf="isFieldInvalid('make')">{{ getFieldError('make') }}</span>
            </div>
            <div class="form-group">
              <label for="model">Modell *</label>
              <input type="text" id="model" class="input" formControlName="model" 
                placeholder="Golf GTI" [class.input--error]="isFieldInvalid('model')">
              <span class="input-error" *ngIf="isFieldInvalid('model')">{{ getFieldError('model') }}</span>
            </div>
          </div>

          <div class="form-row-3">
            <div class="form-group">
              <label for="modelYear">Baujahr</label>
              <input type="number" id="modelYear" class="input" formControlName="modelYear" placeholder="2015">
            </div>
            <div class="form-group">
              <label for="licensePlate">Kennzeichen</label>
              <input type="text" id="licensePlate" class="input" formControlName="licensePlate" placeholder="XX-AB 123">
            </div>
            <div class="form-group">
              <label for="mileageKm">KM *</label>
              <input type="number" id="mileageKm" class="input" formControlName="mileageKm" 
                placeholder="85000" [class.input--error]="isFieldInvalid('mileageKm')">
            </div>
          </div>
        </div>

        <!-- Motor - Always visible -->
        <div class="form-section">
          <div class="form-row-3">
            <div class="form-group">
              <label for="horsepowerPs">PS *</label>
              <input type="number" id="horsepowerPs" class="input" formControlName="horsepowerPs" 
                placeholder="230" [class.input--error]="isFieldInvalid('horsepowerPs')">
            </div>
            <div class="form-group">
              <label for="fuel">Kraftstoff *</label>
              <select id="fuel" class="input" formControlName="fuel">
                <option [value]="FuelType.PETROL">Benzin</option>
                <option [value]="FuelType.DIESEL">Diesel</option>
                <option [value]="FuelType.HYBRID">Hybrid</option>
                <option [value]="FuelType.ELECTRIC">Elektro</option>
                <option [value]="FuelType.LPG">LPG</option>
                <option [value]="FuelType.CNG">CNG</option>
              </select>
            </div>
            <div class="form-group">
              <label for="transmission">Getriebe</label>
              <select id="transmission" class="input" formControlName="transmission">
                <option [ngValue]="null">-</option>
                <option [value]="Transmission.MANUAL">Manuell</option>
                <option [value]="Transmission.AUTOMATIC">Automatik</option>
                <option [value]="Transmission.DSG">DSG</option>
                <option [value]="Transmission.CVT">CVT</option>
              </select>
            </div>
          </div>

          <div class="form-row-3">
            <div class="form-group">
              <label for="torqueNm">Drehm. (Nm)</label>
              <input type="number" id="torqueNm" class="input" formControlName="torqueNm" placeholder="350">
            </div>
            <div class="form-group">
              <label for="displacementCc">Hubraum</label>
              <input type="number" id="displacementCc" class="input" formControlName="displacementCc" placeholder="1984">
            </div>
            <div class="form-group">
              <label for="drivetrain">Antrieb</label>
              <select id="drivetrain" class="input" formControlName="drivetrain">
                <option [ngValue]="null">-</option>
                <option [value]="Drivetrain.FWD">Front</option>
                <option [value]="Drivetrain.RWD">Heck</option>
                <option [value]="Drivetrain.AWD">Allrad</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Bilder -->
        <div class="form-section">
          <label class="section-label">Bilder</label>
          
          <div class="image-grid">
            <!-- Upload Button -->
            <div class="image-upload-card">
              <input type="file" id="imageUpload" accept="image/*" multiple 
                (change)="onImageSelect($event)" style="display: none">
              <label for="imageUpload" class="upload-trigger">
                <span class="material-symbols-outlined" *ngIf="!uploadingImages">add_photo_alternate</span>
                <div class="spinner-small" *ngIf="uploadingImages"></div>
              </label>
            </div>

            <!-- Image Previews -->
            <div class="image-card" *ngFor="let url of imagePreviewUrls; let i = index">
              <img [src]="url" alt="Preview">
              <button type="button" class="remove-btn" (click)="removeImage(i)">
                <span class="material-symbols-outlined">close</span>
              </button>
            </div>
          </div>
        </div>

        <!-- Collapsible Sections -->
        <div class="collapsible-section">
          <button type="button" class="section-toggle" (click)="toggleSection('performance')">
            <span class="toggle-label">Performance</span>
            <span class="material-symbols-outlined">
              {{ expandedSections.performance ? 'expand_less' : 'expand_more' }}
            </span>
          </button>
          <div class="section-content" *ngIf="expandedSections.performance">
            <div class="form-row-2">
              <div class="form-group">
                <label for="zeroToHundredS">0-100 km/h (s)</label>
                <input type="number" step="0.1" id="zeroToHundredS" class="input" formControlName="zeroToHundredS" placeholder="6.5">
              </div>
              <div class="form-group">
                <label for="topSpeedKmh">Vmax (km/h)</label>
                <input type="number" id="topSpeedKmh" class="input" formControlName="topSpeedKmh" placeholder="250">
              </div>
            </div>
            <div class="form-row-2">
              <div class="form-group">
                <label for="powerToWeightPsPerKg">PS/kg</label>
                <input type="number" step="0.01" id="powerToWeightPsPerKg" class="input" formControlName="powerToWeightPsPerKg" placeholder="6.32">
              </div>
              <div class="form-group">
                <label for="consumptionLPer100km">Verbrauch (l/100km)</label>
                <input type="number" step="0.1" id="consumptionLPer100km" class="input" formControlName="consumptionLPer100km" placeholder="7.5">
              </div>
            </div>
          </div>
        </div>

        <div class="collapsible-section">
          <button type="button" class="section-toggle" (click)="toggleSection('body')">
            <span class="toggle-label">Karosserie</span>
            <span class="material-symbols-outlined">
              {{ expandedSections.body ? 'expand_less' : 'expand_more' }}
            </span>
          </button>
          <div class="section-content" *ngIf="expandedSections.body">
            <div class="form-row-2">
              <div class="form-group">
                <label for="bodyType">Typ</label>
                <select id="bodyType" class="input" formControlName="bodyType">
                  <option [ngValue]="null">-</option>
                  <option [value]="BodyType.SEDAN">Limousine</option>
                  <option [value]="BodyType.WAGON">Kombi</option>
                  <option [value]="BodyType.COUPE">Coupé</option>
                  <option [value]="BodyType.CONVERTIBLE">Cabrio</option>
                  <option [value]="BodyType.SUV">SUV</option>
                  <option [value]="BodyType.HATCHBACK">Schrägheck</option>
                </select>
              </div>
              <div class="form-group">
                <label for="kerbWeightKg">Gewicht (kg)</label>
                <input type="number" id="kerbWeightKg" class="input" formControlName="kerbWeightKg" placeholder="1450">
              </div>
            </div>
            <div class="form-row-3">
              <div class="form-group">
                <label for="doors">Türen</label>
                <input type="number" id="doors" class="input" formControlName="doors" placeholder="5">
              </div>
              <div class="form-group">
                <label for="seats">Sitze</label>
                <input type="number" id="seats" class="input" formControlName="seats" placeholder="5">
              </div>
              <div class="form-group">
                <label for="gears">Gänge</label>
                <input type="number" id="gears" class="input" formControlName="gears" placeholder="6">
              </div>
            </div>
            <div class="form-group">
              <label for="induction">Aufladung</label>
              <select id="induction" class="input" formControlName="induction">
                <option [ngValue]="null">-</option>
                <option [value]="Induction.NONE">Saugmotor</option>
                <option [value]="Induction.TURBO">Turbo</option>
                <option [value]="Induction.SUPERCHARGER">Kompressor</option>
              </select>
            </div>
          </div>
        </div>

        <div class="collapsible-section">
          <button type="button" class="section-toggle" (click)="toggleSection('maintenance')">
            <span class="toggle-label">Wartung</span>
            <span class="material-symbols-outlined">
              {{ expandedSections.maintenance ? 'expand_less' : 'expand_more' }}
            </span>
          </button>
          <div class="section-content" *ngIf="expandedSections.maintenance">
            <div class="form-row-2">
              <div class="form-group">
                <label for="nextTuvDate">Nächster TÜV</label>
                <input type="date" id="nextTuvDate" class="input" formControlName="nextTuvDate">
              </div>
              <div class="form-group">
                <label for="nextServiceDate">Nächster Service</label>
                <input type="date" id="nextServiceDate" class="input" formControlName="nextServiceDate">
              </div>
            </div>
            <div class="form-group">
              <label for="nextServiceKm">Service bei (km)</label>
              <input type="number" id="nextServiceKm" class="input" formControlName="nextServiceKm" placeholder="90000">
            </div>
            <div class="form-group">
              <label for="vin">FIN / VIN</label>
              <input type="text" id="vin" class="input" formControlName="vin" placeholder="WVWZZZ1JZYW123456">
            </div>
          </div>
        </div>

      </form>
    </div>

    <!-- Footer -->
    <div class="modal-footer">
      <button class="btn btn--ghost" type="button" (click)="onClose()" [disabled]="loading">
        Abbrechen
      </button>
      <button class="btn btn--primary" type="button" (click)="onSubmit()" [disabled]="loading || carForm.invalid">
        <span class="material-symbols-outlined" *ngIf="!loading">save</span>
        <div class="spinner-small" *ngIf="loading"></div>
        {{ loading ? 'Speichere...' : 'Speichern' }}
      </button>
    </div>

  </div>
</div>