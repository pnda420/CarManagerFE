<section class="survey-page">

    <!-- SUCCESS VIEW -->
    <div *ngIf="isSubmitted()" class="container success-view">
        <div class="success-card">
            <div class="success-icon">
                <span class="material-symbols-outlined ms-fill">check_circle</span>
            </div>

            <div class="success-content">
                <h1>Vielen Dank für deine Anfrage!</h1>
                <p class="success-subtitle">
                    Deine Nachricht ist bei mir angekommen. Ich melde mich in der Regel innerhalb von 24 Stunden bei dir
                    zurück.
                </p>

                <div class="success-details">
                    <div class="detail-item">
                        <span class="material-symbols-outlined">mail</span>
                        <div>
                            <strong>Bestätigung per E-Mail</strong>
                            <span>Du erhältst eine Kopie an {{ form.get('email')?.value }}</span>
                        </div>
                    </div>

                    <div class="detail-item" *ngIf="recommendation().pkg as rec">
                        <span class="material-symbols-outlined">lightbulb</span>
                        <div>
                            <strong>Meine Empfehlung: {{ rec.title }}</strong>
                            <span>Basierend auf deinen Angaben</span>
                        </div>
                    </div>

                    <div class="detail-item">
                        <span class="material-symbols-outlined">schedule</span>
                        <div>
                            <strong>Nächste Schritte</strong>
                            <span>Ich schaue mir deine Anfrage genau an und erstelle ein passendes Angebot</span>
                        </div>
                    </div>
                </div>

                <div class="success-actions">
                    <button type="button" class="btn btn--primary btn--large" (click)="goToHome()">
                        <span class="material-symbols-outlined ms-size-20">home</span>
                        Zur Startseite
                    </button>
                    <button type="button" class="btn btn--ghost" (click)="resetSurvey()">
                        <span class="material-symbols-outlined ms-size-20">refresh</span>
                        Neue Anfrage starten
                    </button>
                </div>

                <div class="success-footer">
                    <p>
                        <span class="material-symbols-outlined">info</span>
                        Hast du noch Fragen? Schreib mir gerne direkt eine E-Mail oder ruf mich an.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- SURVEY VIEW -->
    <ng-container *ngIf="!isSubmitted()">

        <!-- Hero Section -->
        <div class="container hero-section">
            <div class="hero-content">
                <div class="hero-badge">
                    <span class="material-symbols-outlined ms-fill">auto_awesome</span>
                    Interaktive Projekt-Analyse
                </div>
                <h1>Finde dein perfektes Website-Paket</h1>
                <div class="hero-meta">
                    <div class="meta-chip">
                        <span class="material-symbols-outlined">nest_clock_farsight_analog</span>
                        ~2 Minuten
                    </div>
                    <div class="meta-chip meta-chip--highlight">
                        <span class="material-symbols-outlined">line_end_arrow_notch</span>
                        Schritt {{ step() + 1 }} von {{ steps.length }}
                    </div>
                </div>
            </div>
        </div>

        <!-- Progress Bar -->
        <div class="container stepper-section">
            <div class="progress-bar">
                <div class="progress-fill" [style.width.%]="((step() + 1) / steps.length) * 100"></div>
            </div>
        </div>

        <!-- Survey Card -->
        <div class="container survey-content" id="survey">
            <div class="survey-card">

                <!-- Dynamic Step Content -->
                <div *ngFor="let question of questions; let i = index" class="survey-step" [hidden]="step() !== i">

                    <div class="step-header">
                        <span class="step-icon">{{ question.icon }}</span>
                        <h2>{{ question.title }}</h2>
                        <p class="step-subtitle" *ngIf="question.subtitle">{{ question.subtitle }}</p>
                    </div>

                    <!-- Single Choice - Cards Layout -->
                    <div *ngIf="question.type === 'single-choice' && question.layout === 'cards'"
                        class="options-wrapper">
                        <div class="options-grid">
                            <button *ngFor="let opt of question.options" type="button" class="option-card"
                                [class.selected]="form.get(question.formKey)?.value === opt.value"
                                (click)="handleOptionClick(question.formKey, opt.value)">
                                <span class="option-icon">{{ opt.icon }}</span>
                                <strong>{{ opt.label }}</strong>
                                <span class="option-description" *ngIf="opt.hint">{{ opt.hint }}</span>
                            </button>
                        </div>
                    </div>

                    <!-- Single Choice - List Layout -->
                    <div *ngIf="question.type === 'single-choice' && question.layout === 'list'"
                        class="options-wrapper">
                        <div class="options-list">
                            <button *ngFor="let opt of question.options" type="button" class="option-row"
                                [class.selected]="form.get(question.formKey)?.value === opt.value"
                                (click)="handleOptionClick(question.formKey, opt.value)">
                                <div class="option-main">
                                    <span class="option-radio"></span>
                                    <div class="option-text">
                                        <strong>{{ opt.label }}</strong>
                                        <span class="option-hint" *ngIf="opt.hint">{{ opt.hint }}</span>
                                    </div>
                                </div>
                            </button>
                        </div>
                    </div>

                    <!-- Text Input -->
                    <div *ngIf="question.type === 'text'" class="form-field">
                        <textarea [id]="question.formKey" rows="4" class="textarea"
                            [formControl]="$any(form.get(question.formKey))" [placeholder]="question.placeholder || ''"
                            [class.invalid]="!question.optional && $any(form.get(question.formKey))?.invalid && $any(form.get(question.formKey))?.touched">
                        </textarea>
                    </div>

                    <!-- Multiple Choice (Checkboxes) -->
                    <div *ngIf="question.type === 'multiple-choice'" class="features-grid"
                        [formGroup]="$any(specialGroup)">
                        <label *ngFor="let opt of question.options" class="feature-checkbox">
                            <input type="checkbox" [formControlName]="opt.value"
                                (change)="handleCheckboxChange(question.formKey, opt.value, $any($event.target).checked)">
                            <span class="checkbox-custom"></span>
                            <div class="feature-text">
                                <strong>{{ opt.label }}</strong>
                            </div>
                        </label>
                    </div>

                    <!-- Contact Form -->
                    <div *ngIf="question.type === 'contact'" class="contact-form">
                        <div class="form-fields">
                            <div class="form-field" *ngFor="let field of question.fields">
                                <label [for]="field.key">{{ field.label }}</label>
                                <input [id]="field.key" [type]="field.type || 'text'" class="input"
                                    [formControl]="$any(form.get(field.key))" [placeholder]="field.placeholder"
                                    [class.invalid]="field.required && $any(form.get(field.key))?.invalid && $any(form.get(field.key))?.touched">
                            </div>
                        </div>
                    </div>

                    <!-- Navigation Buttons -->
                    <div class="step-actions">
                        <button *ngIf="step() > 0" type="button" class="btn btn--ghost" (click)="prev()">
                            Zurück
                        </button>
                        <button *ngIf="step() < steps.length - 1" type="button" class="btn btn--primary btn--large"
                            [disabled]="!isStepValid(i)" (click)="next()">
                            Weiter
                        </button>
                        <button *ngIf="step() === steps.length - 1" type="button" class="btn btn--primary btn--large"
                            [disabled]="form.invalid || isSubmitting()" (click)="submit()">
                            <span class="material-symbols-outlined ms-size-20" *ngIf="!isSubmitting()">send</span>
                            <span class="material-symbols-outlined ms-size-20 spinning"
                                *ngIf="isSubmitting()">progress_activity</span>
                            {{ isSubmitting() ? 'Wird gesendet...' : 'Empfehlung erhalten' }}
                        </button>
                    </div>
                </div>

            </div>
        </div>

        <!-- Trust Elements -->
        <div class="container" style="text-align: center; margin-top: 2rem; color: #475569; font-size: 0.875rem;">
            <p style="margin: 0;">
                🔒 Deine Daten werden vertraulich behandelt • Keine Verpflichtungen • Kostenlose Beratung
            </p>
        </div>

    </ng-container>

</section>