<div class="tuning-browser-page">
  <!-- Header -->
  <!-- <div class="container">
    <div class="page-header">
      <button class="btn btn--back" routerLink="/mygarage">
        <span class="material-symbols-outlined">arrow_back</span>
        <span class="btn-text">Zurück</span>
      </button>
    </div>
  </div> -->

  <!-- Loading State -->
  <div *ngIf="loading" class="container">
    <div class="loading-container">
      <div class="spinner"></div>
      <p>Lade Daten...</p>
    </div>
  </div>

  <!-- Car Selection Modal -->
  <div *ngIf="!loading && showCarSelection" class="car-selection-overlay">
    <div class="car-selection-modal">
      <div class="modal-header">
        <h2>Wähle ein Auto</h2>
        <p>Für welches Auto möchtest du Tuning-Parts planen?</p>
      </div>

      <div class="cars-grid">
        <div 
          *ngFor="let car of availableCars" 
          class="car-selection-card"
          (click)="selectCar(car)"
        >
          <div class="car-image">
            <img 
              [src]="car.images && car.images.length > 0 ? car.images[0].image : 'assets/images/car-placeholder.jpg'" 
              [alt]="car.name"
            />
          </div>
          <div class="car-info">
            <h3>{{ car.name }}</h3>
            <p class="car-meta">{{ car.make }} {{ car.model }}</p>
            <p class="car-stats">{{ car.horsepowerPs }} PS • {{ car.modelYear }}</p>
          </div>
          <div class="select-icon">
            <span class="material-symbols-outlined">arrow_forward</span>
          </div>
        </div>

        <div *ngIf="availableCars.length === 0" class="empty-state">
          <span class="material-symbols-outlined">directions_car_filled</span>
          <p>Noch keine Autos vorhanden</p>
          <button class="btn btn--primary" routerLink="/mygarage">
            <span class="material-symbols-outlined">add</span>
            Auto hinzufügen
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div *ngIf="!loading && !showCarSelection && car" class="container">
    <!-- Car Header Card -->
    <div class="car-header-card">
      <div class="car-header-content">
        <div class="car-image-preview">
          <img 
            [src]="car.images && car.images.length > 0 ? car.images[0].image : 'assets/images/car-placeholder.jpg'" 
            [alt]="car.name"
          />
        </div>
        
        <div class="car-info-section">
          <div class="car-title-row">
            <div>
              <h1>{{ car.name }}</h1>
              <p class="car-subtitle">{{ car.make }} {{ car.model }}</p>
            </div>
            <button class="btn btn--secondary btn--icon-only" (click)="changeCar()" title="Auto wechseln">
              <span class="material-symbols-outlined">swap_horiz</span>
            </button>
          </div>
          
          <div class="car-quick-stats">
            <span class="quick-stat">
              <span class="material-symbols-outlined">speed</span>
              {{ car.horsepowerPs }} PS
            </span>
            <span class="quick-stat" *ngIf="car.modelYear">
              <span class="material-symbols-outlined">calendar_today</span>
              {{ car.modelYear }}
            </span>
            <span class="quick-stat">
              <span class="material-symbols-outlined">route</span>
              {{ formatNumber(car.mileageKm) }} km
            </span>
          </div>
        </div>
      </div>
    </div>

    <!-- Budget Overview -->
    <div class="budget-overview">
      <div class="budget-card budget-card--total">
        <div class="budget-icon">
          <span class="material-symbols-outlined">account_balance_wallet</span>
        </div>
        <div class="budget-content">
          <span class="budget-label">Gesamt-Budget</span>
          <span class="budget-value">{{ formatPrice(getTotalBudget()) }}</span>
        </div>
      </div>
      
      <div class="budget-card budget-card--spent">
        <div class="budget-icon">
          <span class="material-symbols-outlined">shopping_cart</span>
        </div>
        <div class="budget-content">
          <span class="budget-label">Ausgegeben</span>
          <span class="budget-value">{{ formatPrice(getTotalSpent()) }}</span>
        </div>
      </div>
      
      <div class="budget-card budget-card--remaining">
        <div class="budget-icon">
          <span class="material-symbols-outlined">savings</span>
        </div>
        <div class="budget-content">
          <span class="budget-label">Verfügbar</span>
          <span class="budget-value">{{ formatPrice(getRemainingBudget()) }}</span>
        </div>
      </div>
      
      <div class="budget-card budget-card--parts">
        <div class="budget-icon">
          <span class="material-symbols-outlined">inventory_2</span>
        </div>
        <div class="budget-content">
          <span class="budget-label">Teile gesamt</span>
          <span class="budget-value">{{ getTotalPartsCount() }}</span>
        </div>
      </div>
    </div>

    <!-- Status Overview -->
    <div class="status-overview">
      <div class="status-item status-item--planned" (click)="filterStatus = filterStatus === ModStatus.PLANNED ? null : ModStatus.PLANNED; applyFilters()">
        <span class="material-symbols-outlined">schedule</span>
        <div class="status-info">
          <span class="status-count">{{ getPartsByStatus(ModStatus.PLANNED).length }}</span>
          <span class="status-label">Geplant</span>
        </div>
      </div>
      
      <div class="status-item status-item--ordered" (click)="filterStatus = filterStatus === ModStatus.ORDERED ? null : ModStatus.ORDERED; applyFilters()">
        <span class="material-symbols-outlined">local_shipping</span>
        <div class="status-info">
          <span class="status-count">{{ getPartsByStatus(ModStatus.ORDERED).length }}</span>
          <span class="status-label">Bestellt</span>
        </div>
      </div>
      
      <div class="status-item status-item--installed" (click)="filterStatus = filterStatus === ModStatus.INSTALLED ? null : ModStatus.INSTALLED; applyFilters()">
        <span class="material-symbols-outlined">check_circle</span>
        <div class="status-info">
          <span class="status-count">{{ getPartsByStatus(ModStatus.INSTALLED).length }}</span>
          <span class="status-label">Verbaut</span>
        </div>
      </div>
      
      <div class="status-item status-item--discarded" (click)="filterStatus = filterStatus === ModStatus.DISCARDED ? null : ModStatus.DISCARDED; applyFilters()">
        <span class="material-symbols-outlined">cancel</span>
        <div class="status-info">
          <span class="status-count">{{ getPartsByStatus(ModStatus.DISCARDED).length }}</span>
          <span class="status-label">Verworfen</span>
        </div>
      </div>
    </div>

    <!-- Toolbar -->
    <div class="toolbar">
      <div class="toolbar-left">
        <div class="search-box">
          <span class="material-symbols-outlined">search</span>
          <input 
            type="text" 
            [(ngModel)]="searchQuery"
            (ngModelChange)="onSearchChange()"
            placeholder="Suche nach Teilen..."
            class="search-input"
          />
          <button *ngIf="searchQuery" class="btn-clear" (click)="clearSearch()">
            <span class="material-symbols-outlined">close</span>
          </button>
        </div>
        
        <select [(ngModel)]="sortBy" (ngModelChange)="applySorting()" class="sort-select">
          <option value="orderIndex">Standard</option>
          <option value="title">Name</option>
          <option value="price">Preis</option>
          <option value="status">Status</option>
          <option value="createdAt">Datum</option>
        </select>
      </div>
      
      <div class="toolbar-right">

        <button class="btn btn--primary" (click)="openNewGroupForm()">
          <span class="material-symbols-outlined">add</span>
          <span class="btn-text">Neue Gruppe</span>
        </button>
      </div>
    </div>

    <!-- Groups View -->
    <div *ngIf="viewMode === 'groups'" class="groups-view">
      <div *ngFor="let group of filteredGroups" class="group-section">
        <div class="group-header">
          <div class="group-header-left">
            <h2>{{ group.name }}</h2>
            <span class="parts-count">{{ getGroupParts(group.id).length }} {{ getGroupParts(group.id).length === 1 ? 'Teil' : 'Teile' }}</span>
          </div>
          
          <div class="group-header-right">
            <div class="group-budget-info" *ngIf="group.budgetEur">
              <div class="budget-bar">
                <div 
                  class="budget-fill" 
                  [style.width.%]="getBudgetPercentage(group.id)"
                  [class.over-budget]="getBudgetPercentage(group.id) > 100"
                ></div>
              </div>
              <div class="budget-text">
                <span class="spent">{{ formatPrice(getGroupTotalPrice(group.id)) }}</span>
                <span class="separator">/</span>
                <span class="total">{{ formatPrice(group.budgetEur) }}</span>
              </div>
            </div>
            
            <button class="btn-icon" (click)="editGroup(group)" title="Gruppe bearbeiten">
              <span class="material-symbols-outlined">edit</span>
            </button>
            <button class="btn-icon" (click)="deleteGroup(group)" title="Gruppe löschen">
              <span class="material-symbols-outlined">delete</span>
            </button>
            <button class="btn btn--primary btn--small" (click)="openNewPartForm(group.id)">
              <span class="material-symbols-outlined">add</span>
              <span class="btn-text">Teil</span>
            </button>
          </div>
        </div>

        <div class="parts-grid">
          <div *ngFor="let part of getGroupParts(group.id)" class="part-card" [class]="'status-' + part.status">
            <div class="part-card-header">
              <div class="part-status-badge" [class]="'status-' + part.status">
                {{ getStatusLabel(part.status) }}
              </div>
              <div class="part-actions">
                <button class="btn-icon-small" (click)="cyclePartStatus(part)" title="Status ändern">
                  <span class="material-symbols-outlined">fast_forward</span>
                </button>
                <button class="btn-icon-small" (click)="editPart(part)" title="Bearbeiten">
                  <span class="material-symbols-outlined">edit</span>
                </button>
                <button class="btn-icon-small" (click)="duplicatePart(part)" title="Duplizieren">
                  <span class="material-symbols-outlined">content_copy</span>
                </button>
                <button class="btn-icon-small btn-icon-small--danger" (click)="deletePart(part)" title="Löschen">
                  <span class="material-symbols-outlined">delete</span>
                </button>
              </div>
            </div>

            <h3 class="part-title">{{ part.title }}</h3>
            
            <p *ngIf="part.description" class="part-description">
              {{ part.description }}
            </p>

            <div class="part-details" *ngIf="part.quantity || part.unitPriceEur || part.laborPriceEur">
              <div *ngIf="part.quantity && part.quantity > 1" class="detail-item">
                <span class="material-symbols-outlined">counter_1</span>
                <span>{{ part.quantity }}x</span>
              </div>
              
              <div *ngIf="part.unitPriceEur" class="detail-item">
                <span class="material-symbols-outlined">sell</span>
                <span>{{ formatPrice(part.unitPriceEur) }}</span>
              </div>
              
              <div *ngIf="part.laborPriceEur" class="detail-item">
                <span class="material-symbols-outlined">build</span>
                <span>{{ formatPrice(part.laborPriceEur) }}</span>
              </div>
            </div>

            <div class="part-footer">
              <div class="part-total">
                <span class="total-label">Gesamt</span>
                <span class="total-value">{{ formatPrice(getPartTotalPrice(part)) }}</span>
              </div>
              
              <a *ngIf="part.link" [href]="part.link" target="_blank" class="part-link" (click)="$event.stopPropagation()">
                <span class="material-symbols-outlined">link</span>
              </a>
            </div>
          </div>

          <button *ngIf="getGroupParts(group.id).length === 0" class="empty-group-btn" (click)="openNewPartForm(group.id)">
            <span class="material-symbols-outlined">add_circle</span>
            <span>Erstes Teil hinzufügen</span>
          </button>
        </div>
      </div>

      <div *ngIf="filteredGroups.length === 0" class="empty-state">
        <span class="material-symbols-outlined">folder_off</span>
        <p>{{ searchQuery ? 'Keine Gruppen gefunden' : 'Noch keine Gruppen vorhanden' }}</p>
        <button *ngIf="!searchQuery" class="btn btn--primary" (click)="openNewGroupForm()">
          <span class="material-symbols-outlined">add</span>
          Erste Gruppe erstellen
        </button>
      </div>
    </div>

    <!-- List View -->
    <div *ngIf="viewMode === 'list'" class="list-view">
      <div class="list-table">
        <div class="table-header">
          <div class="col-status">Status</div>
          <div class="col-title">Teil</div>
          <div class="col-group">Gruppe</div>
          <div class="col-quantity">Menge</div>
          <div class="col-price">Stückpreis</div>
          <div class="col-labor">Montage</div>
          <div class="col-total">Gesamt</div>
          <div class="col-actions">Aktionen</div>
        </div>

        <div class="table-body">
          <div *ngFor="let part of getAllFilteredParts()" class="table-row" [class]="'status-' + part.status">
            <div class="col-status">
              <div class="status-badge" [class]="'status-' + part.status">
                {{ getStatusLabel(part.status) }}
              </div>
            </div>
            
            <div class="col-title">
              <div class="title-cell">
                <strong>{{ part.title }}</strong>
                <small *ngIf="part.description">{{ part.description }}</small>
                <a *ngIf="part.link" [href]="part.link" target="_blank" class="inline-link">
                  <span class="material-symbols-outlined">link</span>
                </a>
              </div>
            </div>
            
            <div class="col-group">
              {{ getGroupName(part.groupId) }}
            </div>
            
            <div class="col-quantity">
              {{ part.quantity || 1 }}x
            </div>
            
            <div class="col-price">
              {{ part.unitPriceEur ? formatPrice(part.unitPriceEur) : '-' }}
            </div>
            
            <div class="col-labor">
              {{ part.laborPriceEur ? formatPrice(part.laborPriceEur) : '-' }}
            </div>
            
            <div class="col-total">
              <strong>{{ formatPrice((part.totalPriceEur || 0) + (part.laborPriceEur || 0)) }}</strong>
            </div>
            
            <div class="col-actions">
              <button class="btn-icon-small" (click)="cyclePartStatus(part)" title="Status ändern">
                <span class="material-symbols-outlined">fast_forward</span>
              </button>
              <button class="btn-icon-small" (click)="editPart(part)" title="Bearbeiten">
                <span class="material-symbols-outlined">edit</span>
              </button>
              <button class="btn-icon-small" (click)="duplicatePart(part)" title="Duplizieren">
                <span class="material-symbols-outlined">content_copy</span>
              </button>
              <button class="btn-icon-small" (click)="deletePart(part)" title="Löschen">
                <span class="material-symbols-outlined">delete</span>
              </button>
            </div>
          </div>
        </div>

        <div *ngIf="getAllFilteredParts().length === 0" class="empty-state">
          <span class="material-symbols-outlined">inventory_2</span>
          <p>Keine Teile gefunden</p>
        </div>
      </div>
    </div>

    <!-- Kanban Board View -->
    <div *ngIf="viewMode === 'board'" class="board-view">
      <div class="board-columns">
        <div class="board-column" *ngFor="let status of statuses">
          <div class="column-header">
            <h3>{{ getStatusLabel(status) }}</h3>
            <span class="column-count">{{ getPartsByStatus(status).length }}</span>
          </div>

          <div class="column-content">
            <div 
              *ngFor="let part of getPartsByStatus(status)" 
              class="board-card"
              [class]="'status-' + status"
            >
              <div class="board-card-header">
                <span class="group-tag">{{ getGroupName(part.groupId) }}</span>
                <div class="card-actions">
                  <button class="btn-icon-small" (click)="editPart(part)">
                    <span class="material-symbols-outlined">edit</span>
                  </button>
                  <button class="btn-icon-small" (click)="deletePart(part)">
                    <span class="material-symbols-outlined">delete</span>
                  </button>
                </div>
              </div>

              <h4>{{ part.title }}</h4>
              
              <p *ngIf="part.description" class="card-description">
                {{ part.description }}
              </p>

              <div class="card-details">
                <span *ngIf="part.quantity && part.quantity > 1">
                  <span class="material-symbols-outlined">counter_1</span>
                  {{ part.quantity }}x
                </span>
                <span *ngIf="part.unitPriceEur">
                  <span class="material-symbols-outlined">sell</span>
                  {{ formatPrice(part.unitPriceEur) }}
                </span>
              </div>

              <div *ngIf="part.totalPriceEur || part.laborPriceEur" class="card-total">
                {{ formatPrice((part.totalPriceEur || 0) + (part.laborPriceEur || 0)) }}
              </div>

              <a *ngIf="part.link" [href]="part.link" target="_blank" class="card-link">
                <span class="material-symbols-outlined">link</span>
              </a>
            </div>

            <div *ngIf="getPartsByStatus(status).length === 0" class="column-empty">
              <span class="material-symbols-outlined">inventory_2</span>
              <p>Keine Teile</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- New/Edit Group Modal -->
<div *ngIf="showGroupModal" class="modal-overlay">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>{{ editingGroup ? 'Gruppe bearbeiten' : 'Neue Gruppe' }}</h2>
      <button class="btn-close" (click)="closeGroupModal()">
        <span class="material-symbols-outlined">close</span>
      </button>
    </div>

    <div class="modal-body">
      <div class="form-group">
        <label>Gruppenname *</label>
        <input type="text" [(ngModel)]="groupForm.name" class="form-input" placeholder="z.B. Motor-Upgrades" />
      </div>

      <div class="form-group">
        <label>Budget (EUR)</label>
        <input type="number" [(ngModel)]="groupForm.budgetEur" class="form-input" placeholder="0.00" step="0.01" />
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn btn--secondary" (click)="closeGroupModal()">Abbrechen</button>
      <button class="btn btn--primary" (click)="saveGroup()">
        {{ editingGroup ? 'Speichern' : 'Erstellen' }}
      </button>
    </div>
  </div>
</div>

<!-- New/Edit Part Modal -->
<div *ngIf="showPartModal" class="modal-overlay">
  <div class="modal-content modal-content--large" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>{{ editingPart ? 'Teil bearbeiten' : 'Neues Teil' }}</h2>
      <button class="btn-close" (click)="closePartModal()">
        <span class="material-symbols-outlined">close</span>
      </button>
    </div>

    <div class="modal-body">
      <div class="form-row">
        <div class="form-group form-group--full">
          <label>Titel *</label>
          <input type="text" [(ngModel)]="partForm.title" class="form-input" placeholder="z.B. K&N Luftfilter" />
        </div>
      </div>

      <div class="form-group">
        <label>Beschreibung</label>
        <textarea [(ngModel)]="partForm.description" class="form-textarea" rows="3" placeholder="Details, Spezifikationen..."></textarea>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Gruppe *</label>
          <select [(ngModel)]="partForm.groupId" class="form-select">
            <option *ngFor="let group of tuningGroups" [value]="group.id">
              {{ group.name }}
            </option>
          </select>
        </div>

        <div class="form-group">
          <label>Status</label>
          <select [(ngModel)]="partForm.status" class="form-select">
            <option [value]="ModStatus.PLANNED">Geplant</option>
            <option [value]="ModStatus.ORDERED">Bestellt</option>
            <option [value]="ModStatus.INSTALLED">Verbaut</option>
            <option [value]="ModStatus.DISCARDED">Verworfen</option>
          </select>
        </div>

        <div class="form-group">
          <label>Menge</label>
          <input type="number" [(ngModel)]="partForm.quantity" class="form-input" min="1" />
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Stückpreis (EUR)</label>
          <input type="number" [(ngModel)]="partForm.unitPriceEur" class="form-input" step="0.01" placeholder="0.00" />
        </div>

        <div class="form-group">
          <label>Gesamtpreis (EUR)</label>
          <input type="number" [(ngModel)]="partForm.totalPriceEur" class="form-input" step="0.01" placeholder="0.00" />
        </div>

        <div class="form-group">
          <label>Montagekosten (EUR)</label>
          <input type="number" [(ngModel)]="partForm.laborPriceEur" class="form-input" step="0.01" placeholder="0.00" />
        </div>
      </div>

      <div class="form-group">
        <label>Link (Shop, Artikel, etc.)</label>
        <input type="url" [(ngModel)]="partForm.link" class="form-input" placeholder="https://..." />
      </div>

      <div class="form-group">
        <label>Notizen</label>
        <textarea [(ngModel)]="partForm.notes" class="form-textarea" rows="2" placeholder="Zusätzliche Informationen..."></textarea>
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn btn--secondary" (click)="closePartModal()">Abbrechen</button>
      <button class="btn btn--primary" (click)="savePart()">
        {{ editingPart ? 'Speichern' : 'Hinzufügen' }}
      </button>
    </div>
  </div>
</div>