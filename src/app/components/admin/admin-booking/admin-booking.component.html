<app-admin-header></app-admin-header>

<div class="admin-bookings">
    <div class="container">

        <!-- Header mit Stats -->
        <div class="page-header">
            <div class="header-top">
                <div>
                    <h1 class="page-title">Slot Manager</h1>
                    <p class="page-subtitle">Kalenderansicht deiner Buchungszeiten</p>
                </div>
                <div class="header-actions">
                    <button class="btn-primary" (click)="openCreateModal()">
                        <span>✨</span> Neue Slots erstellen
                    </button>
                    <button class="btn-icon" (click)="loadSlots()" [disabled]="loading" title="Aktualisieren">
                        <span [class.spin]="loading">🔄</span>
                    </button>
                </div>
            </div>

            <!-- Kompakte Stats -->
            <div class="stats-compact">
                <div class="stat-item">
                    <span class="stat-icon">📊</span>
                    <strong>{{ stats.total }}</strong>
                    <span>Gesamt</span>
                </div>
                <div class="stat-item">
                    <span class="stat-icon">✅</span>
                    <strong>{{ stats.available }}</strong>
                    <span>Frei</span>
                </div>
                <div class="stat-item">
                    <span class="stat-icon">🎯</span>
                    <strong>{{ stats.booked }}</strong>
                    <span>Gebucht</span>
                </div>
                <div class="stat-item">
                    <span class="stat-icon">🔮</span>
                    <strong>{{ stats.upcoming }}</strong>
                    <span>Bevorstehend</span>
                </div>
            </div>
        </div>

        <!-- Kalender Navigation -->
        <div class="calendar-nav">
            <button class="nav-btn" (click)="previousMonth()">◀</button>
            <div class="nav-center">
                <h2>{{ getCurrentMonthYear() }}</h2>
                <button class="btn-today" (click)="goToToday()">Heute</button>
            </div>
            <button class="nav-btn" (click)="nextMonth()">▶</button>
        </div>

        <!-- Filter Bar -->
        <div class="filter-bar">
            <select [(ngModel)]="filters.status" (change)="onFilterChange()" class="filter-input">
                <option value="all">Alle Status</option>
                <option value="available">Nur Verfügbar</option>
                <option value="booked">Nur Gebucht</option>
                <option value="unavailable">Nur Gesperrt</option>
            </select>

            <input type="text" [(ngModel)]="filters.searchText" (input)="onFilterChange()" class="filter-input search"
                placeholder="🔍 Name, Email, Telefon..." />

            <button class="btn-icon" (click)="clearFilters()" title="Filter zurücksetzen">
                🔄
            </button>

            <div class="filter-count">
                {{ getFilteredSlotsCount() }} Slots gefiltert
            </div>
        </div>

        <!-- Kalender Grid -->
        <div class="calendar-container">
            <div class="calendar-header">
                <div class="weekday" *ngFor="let day of weekDays">{{ day }}</div>
            </div>

            <div class="calendar-grid">
                <div *ngFor="let day of calendarDays" class="calendar-day" [class.other-month]="!day.isCurrentMonth"
                    [class.today]="isToday(day.date)" [class.has-slots]="day.slots.length > 0">

                    <div class="day-header">
                        <span class="day-number">{{ day.date.getDate() }}</span>
                        <span class="slot-count" *ngIf="day.slots.length > 0">
                            {{ day.slots.length }}
                        </span>
                    </div>

                    <div class="day-slots" *ngIf="day.slots.length > 0">
                        <div *ngFor="let slot of day.slots.slice(0, 3)" class="slot-preview"
                            [class.available]="slot.isAvailable && (slot.currentBookings || 0) === 0"
                            [class.booked]="(slot.currentBookings || 0) > 0" [class.unavailable]="!slot.isAvailable"
                            (click)="openSlotModal(slot)">
                            <span class="slot-time">{{ formatTime(slot.timeFrom) }}</span>
                            <span class="slot-status">
                                {{ getSlotStatusIcon(slot) }}
                            </span>
                        </div>
                        <button *ngIf="day.slots.length > 3" class="more-slots" (click)="openDayModal(day)">
                            +{{ day.slots.length - 3 }} mehr
                        </button>
                    </div>

                    <button *ngIf="day.isCurrentMonth && day.slots.length === 0" class="btn-add-slot"
                        (click)="openQuickCreateForDay(day.date)" title="Slot hinzufügen">
                        +
                    </button>
                </div>
            </div>
        </div>

        <!-- Loading State -->
        <div *ngIf="loading" class="loading-overlay">
            <div class="spinner"></div>
            <p>Lade Kalender...</p>
        </div>

    </div>
</div>

<!-- Modal: Slot erstellen -->
<div class="modal-overlay" *ngIf="showCreateModal" (click)="closeCreateModal()">
    <div class="modal" (click)="$event.stopPropagation()">
        <div class="modal-header">
            <h2>🎨 Slot-Serie erstellen</h2>
            <button class="modal-close" (click)="closeCreateModal()">✕</button>
        </div>

        <div class="modal-body">
            <!-- Pattern Selection -->
            <div class="form-section">
                <label>Muster</label>
                <div class="pattern-grid">
                    <button *ngFor="let pattern of seriesPatterns" class="pattern-btn"
                        [class.active]="quickCreate.pattern === pattern.id" (click)="quickCreate.pattern = pattern.id">
                        <span>{{ pattern.icon }}</span>
                        <small>{{ pattern.name }}</small>
                    </button>
                </div>
            </div>

            <!-- Custom Days -->
            <div class="form-section" *ngIf="quickCreate.pattern === 'custom'">
                <label>Wochentage</label>
                <div class="days-grid">
                    <button *ngFor="let day of [
                        {num: 1, name: 'Mo'}, {num: 2, name: 'Di'}, {num: 3, name: 'Mi'},
                        {num: 4, name: 'Do'}, {num: 5, name: 'Fr'}, {num: 6, name: 'Sa'}, {num: 0, name: 'So'}
                    ]" class="day-btn" [class.active]="isCustomDaySelected(day.num)"
                        (click)="toggleCustomDay(day.num)">
                        {{ day.name }}
                    </button>
                </div>
            </div>

            <!-- Date & Time -->
            <div class="form-row">
                <div class="form-group">
                    <label>Von</label>
                    <input type="date" [(ngModel)]="quickCreate.startDate" class="input-field" />
                </div>
                <div class="form-group">
                    <label>Bis</label>
                    <input type="date" [(ngModel)]="quickCreate.endDate" class="input-field" />
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Start</label>
                    <input type="time" [(ngModel)]="quickCreate.startTime" class="input-field" />
                </div>
                <div class="form-group">
                    <label>Ende</label>
                    <input type="time" [(ngModel)]="quickCreate.endTime" class="input-field" />
                </div>
            </div>

            <!-- Slot Configuration -->
            <div class="form-row">
                <div class="form-group">
                    <label>Dauer (Min)</label>
                    <input type="number" min="15" step="15" [(ngModel)]="quickCreate.slotDuration"
                        class="input-field" />
                </div>
                <div class="form-group">
                    <label>Pause nach</label>
                    <input type="number" min="0" [(ngModel)]="quickCreate.breakAfter" class="input-field" />
                </div>
                <div class="form-group" *ngIf="quickCreate.breakAfter > 0">
                    <label>Pausendauer</label>
                    <input type="number" min="0" step="5" [(ngModel)]="quickCreate.breakDuration" class="input-field" />
                </div>
            </div>

            <div class="preview-box">
                🎯 <strong>{{ getPreviewCount() }}</strong> Slots werden erstellt
            </div>
        </div>

        <div class="modal-footer">
            <button class="btn-secondary" (click)="closeCreateModal()">Abbrechen</button>
            <button class="btn-primary" (click)="handleCreateSeries()" [disabled]="loadingCreate">
                <span *ngIf="!loadingCreate">🚀 Slots erstellen</span>
                <span *ngIf="loadingCreate">⏳ Erstelle...</span>
            </button>
        </div>
    </div>
</div>

<!-- Modal: Slot Details -->
<div class="modal-overlay" *ngIf="selectedSlot" (click)="closeSlotModal()">
    <div class="modal" (click)="$event.stopPropagation()">
        <div class="modal-header">
            <h2>📅 Slot Details</h2>
            <button class="modal-close" (click)="closeSlotModal()">✕</button>
        </div>

        <div class="modal-body">
            <div class="slot-detail-header">
                <div class="detail-date">
                    <strong>{{ formatDateLong(selectedSlot.date) }}</strong>
                    <span>{{ formatTime(selectedSlot.timeFrom) }} - {{ formatTime(selectedSlot.timeTo) }}</span>
                </div>
                <div class="detail-status">
                    <span class="status-badge"
                        [class.status-available]="selectedSlot.isAvailable && (selectedSlot.currentBookings || 0) === 0"
                        [class.status-booked]="(selectedSlot.currentBookings || 0) > 0"
                        [class.status-unavailable]="!selectedSlot.isAvailable">
                        {{ getSlotStatusText(selectedSlot) }}
                    </span>
                </div>
            </div>

            <div class="slot-info-grid">
                <div class="info-item">
                    <label>Max. Buchungen</label>
                    <strong>{{ selectedSlot.maxBookings }}</strong>
                </div>
                <div class="info-item">
                    <label>Aktuelle Buchungen</label>
                    <strong>{{ selectedSlot.currentBookings || 0 }}</strong>
                </div>
                <div class="info-item">
                    <label>Status</label>
                    <strong>{{ selectedSlot.isAvailable ? 'Verfügbar' : 'Gesperrt' }}</strong>
                </div>
            </div>

            <!-- Buchungen -->
            <div class="bookings-section" *ngIf="selectedSlotBookings && selectedSlotBookings.length > 0">
                <h3>Buchungen ({{ selectedSlotBookings.length }})</h3>

                <div class="booking-list">
                    <div *ngFor="let booking of selectedSlotBookings" class="booking-card">
                        <div class="booking-header">
                            <strong>{{ booking.name }}</strong>
                            <span class="booking-badge" [style.color]="getStatusColor(booking.status)">
                                {{ getStatusLabel(booking.status) }}
                            </span>
                        </div>

                        <div class="booking-details">
                            <div>📧 {{ booking.email }}</div>
                            <div *ngIf="booking.phone">📞 {{ booking.phone }}</div>
                            <div *ngIf="booking.message" class="booking-message">
                                💬 {{ booking.message }}
                            </div>
                        </div>

                        <div class="booking-actions">
                            <button class="btn-action confirm"
                                (click)="updateBookingStatus(booking.id, BookingStatus.CONFIRMED)"
                                *ngIf="booking.status === BookingStatus.PENDING">
                                ✅ Bestätigen
                            </button>
                            <button class="btn-action cancel"
                                (click)="updateBookingStatus(booking.id, BookingStatus.CANCELLED)"
                                *ngIf="booking.status !== BookingStatus.CANCELLED">
                                ❌ Absagen
                            </button>
                            <button class="btn-action complete"
                                (click)="updateBookingStatus(booking.id, BookingStatus.COMPLETED)"
                                *ngIf="booking.status === BookingStatus.CONFIRMED">
                                🎉 Abschließen
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="empty-bookings" *ngIf="!selectedSlotBookings || selectedSlotBookings.length === 0">
                <p>Keine Buchungen vorhanden</p>
            </div>
        </div>

        <div class="modal-footer">
            <button class="btn-danger" (click)="handleDeleteSlot(selectedSlot.id)">
                🗑️ Slot löschen
            </button>
            <button class="btn-secondary" (click)="closeSlotModal()">Schließen</button>
        </div>
    </div>
</div>

<!-- Modal: Tagesübersicht -->
<div class="modal-overlay" *ngIf="selectedDay" (click)="closeDayModal()">
    <div class="modal modal-wide" (click)="$event.stopPropagation()">
        <div class="modal-header">
            <h2>📅 {{ formatDateLongFromDate(selectedDay.date) }}</h2> <!-- statt toISOString() -->

            <button class="modal-close" (click)="closeDayModal()">✕</button>
        </div>

        <div class="modal-body">
            <div class="day-slots-grid">
                <div *ngFor="let slot of selectedDay.slots" class="day-slot-card"
                    (click)="openSlotModal(slot); closeDayModal()">

                    <div class="slot-time-range">
                        <strong>{{ formatTime(slot.timeFrom) }} - {{ formatTime(slot.timeTo) }}</strong>
                    </div>

                    <div class="slot-status-info">
                        <span class="status-indicator"
                            [class.available]="slot.isAvailable && (slot.currentBookings || 0) === 0"
                            [class.booked]="(slot.currentBookings || 0) > 0" [class.unavailable]="!slot.isAvailable">
                            {{ getSlotStatusIcon(slot) }}
                        </span>
                        <span>{{ slot.currentBookings || 0 }}/{{ slot.maxBookings }} gebucht</span>
                    </div>

                    <div class="slot-booking-preview" *ngIf="getSlotBookings(slot).length > 0">
                        <small>Buchungen:</small>
                        <div class="booking-names">
                            {{ getBookingNames(slot) }}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal-footer">
            <button class="btn-primary" (click)="openQuickCreateForDay(selectedDay.date); closeDayModal()">
                ✨ Neue Slots hinzufügen
            </button>
            <button class="btn-secondary" (click)="closeDayModal()">Schließen</button>
        </div>
    </div>
</div>