<app-admin-header></app-admin-header>

<section class="admin-requests">
    <div class="container">

        <!-- Header mit Stats -->
        <div class="requests__header">
            <div class="header__info">
                <h2>Kontaktanfragen</h2>
                <p class="subtitle">Verwalte alle eingehenden Anfragen</p>
            </div>

            <div class="header__badges">
                <div class="badge badge--primary" aria-label="Offene Anfragen">
                    <span class="count">{{ unprocessedRequests.length || 0 }}</span>
                    <span class="label">Offen</span>
                </div>
                <div class="badge badge--secondary" aria-label="Bearbeitete Anfragen">
                    <span class="count">{{ processedRequests.length || 0 }}</span>
                    <span class="label">Bearbeitet</span>
                </div>
            </div>
        </div>

        <!-- Tabs, horizontal scroll auf Mobile -->
        <div class="tabs" role="tablist">
            <button class="tab" role="tab" [attr.aria-selected]="activeTab === 'unprocessed'"
                [class.tab--active]="activeTab === 'unprocessed'" (click)="switchTab('unprocessed')">
                Offen ({{ unprocessedRequests.length || 0 }})
            </button>
            <button class="tab" role="tab" [attr.aria-selected]="activeTab === 'processed'"
                [class.tab--active]="activeTab === 'processed'" (click)="switchTab('processed')">
                Bearbeitet ({{ processedRequests.length || 0 }})
            </button>
        </div>

        <!-- Loading -->
        <div *ngIf="loading" class="loading-state">
            <div class="spinner"></div>
            <p>Lade Anfragen...</p>
        </div>

        <!-- Error -->
        <div *ngIf="error && !loading" class="error-state">
            <p>❌ {{ error }}</p>
            <button class="btn btn--secondary" (click)="loadRequests()">Erneut versuchen</button>
        </div>

        <!-- Empty -->
        <div *ngIf="!loading && !error && currentRequests.length === 0" class="empty-state">
            <div class="empty__icon">
                <span *ngIf="activeTab === 'unprocessed'">🎉</span>
                <span *ngIf="activeTab === 'processed'">📭</span>
            </div>
            <h3 *ngIf="activeTab === 'unprocessed'">Keine offenen Anfragen</h3>
            <h3 *ngIf="activeTab === 'processed'">Noch keine bearbeiteten Anfragen</h3>
            <p *ngIf="activeTab === 'unprocessed'">Alle Anfragen wurden bearbeitet!</p>
            <p *ngIf="activeTab === 'processed'">Bearbeitete Anfragen erscheinen hier.</p>
        </div>

        <!-- List: kompakte Karten im Auto-Grid -->
        <div *ngIf="!loading && !error && currentRequests.length > 0" class="requests__list">
            <article *ngFor="let request of currentRequests; trackBy: trackById" class="request-card">

                <!-- Kopfzeile -->
                <header class="card__header">
                    <div class="header__left">
                        <h3 class="name" [title]="request.name || '—'">{{ request.name || '—' }}</h3>
                        <div class="meta-row">
                            <span class="time">{{ formatDate(request.createdAt) }}</span>
                            <span class="dot">•</span>
                            <span class="id" [title]="request.id">ID: {{ request.id | slice:0:6 }}…</span>
                        </div>
                    </div>

                    <div class="header__right">
                        <span *ngIf="request.serviceType !== undefined" class="service-badge">
                            {{ getServiceLabel(request.serviceType) }}
                        </span>
                    </div>
                </header>

                <!-- Kontakt-Zeile, einzeilig; wraps bei wenig Platz -->
                <div class="card__contact">
                    <a class="contact__item" [href]="'mailto:'+request.email" (click)="$event.stopPropagation()">
                        <span class="icon" aria-hidden="true">✉️</span>
                        <span class="value" [title]="request.email">{{ request.email || '—' }}</span>
                    </a>

                    <a *ngIf="request.phoneNumber" class="contact__item" [href]="'tel:'+request.phoneNumber"
                        (click)="$event.stopPropagation()">
                        <span class="icon" aria-hidden="true">📞</span>
                        <span class="value" [title]="request.phoneNumber">{{ request.phoneNumber }}</span>
                    </a>

                    <span *ngIf="request.prefersCallback" class="chip chip--success">🔔 Rückruf</span>
                </div>

                <!-- Nachricht einklappbar (default zu) -->
                <details class="card__message" [attr.name]="'msg-'+request.id">
                    <summary>Nachricht anzeigen</summary>
                    <div class="message__content">
                        <pre class="message__text">{{ request.message || '—' }}</pre>
                    </div>
                </details>

                <!-- Alle weiteren Felder (generisch) -->
                <details class="card__details">
                    <summary>Weitere Details</summary>
                    <dl class="kv">
                        <ng-container *ngFor="let f of getAdditionalFields(request)">
                            <dt>{{ f.key }}</dt>
                            <dd>
                                <span *ngIf="f.isDate">{{ f.value | date:'short' }}</span>
                                <span *ngIf="!f.isDate">{{ f.value }}</span>
                            </dd>
                        </ng-container>
                    </dl>
                </details>

                <!-- Aktionen (Icon-Buttons auf Mobile) -->
                <div class="card__actions">
                    <a class="btn btn--primary"
                        [href]="'mailto:'+request.email+'?subject=Re: Deine Anfrage bei LeonardsMedia'">
                        <span class="btn__icon" aria-hidden="true">✉️</span>
                        <span class="btn__label">E-Mail</span>
                    </a>

                    <a *ngIf="request.phoneNumber" class="btn btn--secondary" [href]="'tel:'+request.phoneNumber">
                        <span class="btn__icon" aria-hidden="true">📞</span>
                        <span class="btn__label">Anrufen</span>
                    </a>

                    <button *ngIf="activeTab === 'unprocessed'" class="btn btn--ghost"
                        (click)="markAsProcessed(request.id)">
                        <span class="btn__icon" aria-hidden="true">✅</span>
                        <span class="btn__label">Als bearbeitet</span>
                    </button>

                    <ng-container *ngIf="activeTab === 'processed'">
                        <button class="btn btn--ghost" (click)="markAsUnprocessed(request.id)">
                            <span class="btn__icon" aria-hidden="true">↩️</span>
                            <span class="btn__label">Wieder öffnen</span>
                        </button>
                        <button class="btn btn--danger" (click)="requestToDelete = request.id; showModal = true">
                            <span class="btn__icon" aria-hidden="true">🗑️</span>
                            <span class="btn__label">Löschen</span>
                        </button>
                    </ng-container>
                </div>
            </article>
        </div>

    </div>
</section>

<app-confirmation [isOpen]="showModal" [config]="modalConfig" [loading]="modalLoading" (confirmed)="onConfirmDelete()"
    (cancelled)="onCancelDelete()">
</app-confirmation>